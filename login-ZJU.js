/**
 * login-ZJU: A server-side library helping your application login to ZJU services
 * @author 5dbwat4<me@5dbwat4.top>
 * @version 1.0.2
 */
var m=class{domain;path;secure;script;static All=Object.freeze(Object.create(null));constructor(t,e,o,n){this.domain=t||void 0,this.path=e||"/",this.secure=!!o,this.script=!!n}},J=/[:](?=\s*[a-zA-Z0-9_\-]+\s*[=])/g,d=class r{name=null;value=null;expiration_date=1/0;path="/";explicit_path=!1;domain=null;explicit_domain=!1;secure=!1;noscript=!1;constructor(t,e,o){if(t instanceof r){Object.assign(this,t);return}this.path=String(o||"/"),this.domain=e||null,t&&this.parse(t,e,o)}toString(){let t=[this.name+"="+this.value];return this.expiration_date!==1/0&&t.push("expires="+new Date(this.expiration_date).toUTCString()),this.domain&&t.push("domain="+this.domain),this.path&&t.push("path="+this.path),this.secure&&t.push("secure"),this.noscript&&t.push("httponly"),t.join("; ")}toValueString(){return this.name+"="+this.value}parse(t,e,o){if(typeof t!="string")return;if(t.length>32768){console.warn("Cookie too long for parsing (>32768 characters)");return}let n=t.split(";").filter(Boolean),a=n[0].match(/([^=]+)=([\s\S]*)/);if(!a){console.warn("Invalid cookie header encountered. Header: '"+t+"'");return}let c=a[1],s=a[2];if(typeof c!="string"||c.length===0||typeof s!="string"){console.warn("Unable to extract values from cookie header. Cookie: '"+t+"'");return}this.name=c,this.value=s;for(let i=1;i<n.length;i+=1){let g=n[i].match(/([^=]+)(?:=([\s\S]*))?/);if(g)switch(c=g[1].trim().toLowerCase(),s=g[2],c){case"httponly":this.noscript=!0;break;case"expires":this.expiration_date=s?Number(Date.parse(s)):1/0;break;case"path":this.path=s?s.trim():"",this.explicit_path=!0;break;case"domain":this.domain=s?s.trim():"",this.explicit_domain=!!this.domain;break;case"secure":this.secure=!0;break}}return this.explicit_path||(this.path=o||"/"),this.explicit_domain||(this.domain=e||this.domain),this}matches(t){return t===m.All?!0:!(this.noscript&&t.script||this.secure&&!t.secure||!this.collidesWith(t))}collidesWith(t){if(this.path&&!t.path||this.domain&&!t.domain||this.path&&t.path.indexOf(this.path)!==0||this.explicit_path&&t.path.indexOf(this.path)!==0)return!1;let e=t.domain&&t.domain.replace(/^[\.]/,""),o=this.domain&&this.domain.replace(/^[\.]/,"");if(o===e)return!0;if(o){if(!this.explicit_domain)return!1;let n=e.indexOf(o);return!(n===-1||n!==e.length-o.length)}return!0}},p=class{cookies;constructor(){this.cookies=Object.create(null)}setCookie(t,e,o){let n=t instanceof d?t:new d(t,e,o),a=n.expiration_date<=Date.now(),c=n.name,s=this.cookies[c];if(s!==void 0){for(let i=0;i<s.length;i+=1)if(s[i].collidesWith(n))return a?(s.splice(i,1),s.length===0&&delete this.cookies[c],!1):(s[i]=n,n);return a?!1:(s.push(n),n)}return a?!1:(this.cookies[c]=[n],this.cookies[c])}getCookie(t,e){let o=this.cookies[t];if(o)for(let n=0;n<o.length;n+=1){let a=o[n];if(a.expiration_date<=Date.now()){o.length===0&&delete this.cookies[a.name];continue}if(a.matches(e))return a}}getCookies(t){let e=[];for(let o in this.cookies){let n=this.getCookie(o,t);n&&e.push(n)}return e.toString=function(){return e.join(":")},e.toValueString=function(){return e.map(function(n){return n.toValueString()}).join("; ")},e}setCookies(t,e,o){let n=Array.isArray(t)?t:t.split(J),a=[],c=n.map(s=>s instanceof d?s:new d(s,e,o));for(let s=0;s<c.length;s+=1){let i=c[s];this.setCookie(i,e,o)&&a.push(i)}return a}};function u(){return new p}function M(r){let t={};if(!r)return t;if(r instanceof Headers){for(let[e,o]of r.entries())t[e.toLowerCase()]=o;return t}if(Array.isArray(r)){for(let[e,o]of r)t[e.toLowerCase()]=o;return t}for(let e of Object.keys(r)){let o=r[e];t[e.toLowerCase()]=String(o)}return t}async function v(r,t,e){let o=e||u(),n=typeof r=="string"?r:r instanceof Request?r.url:String(r),a=new URL(n,"http://localhost"),c=a.hostname,s=a.pathname||"/",i=M(t&&t.headers?t.headers:void 0),g=new m(c,s,a.protocol==="https:",!1),f=o.getCookies(g),k=f&&f.toValueString?f.toValueString():f.length?f.map(h=>h.toValueString()).join("; "):"";if(k){let h=i.cookie;i.cookie=h?h+"; "+k:k}let z=new Headers;for(let h of Object.keys(i))z.set(h,i[h]);let I=Object.assign({},t,{headers:z}),R=await fetch(r,I),w=[];for(let[h,j]of R.headers)h.toLowerCase()==="set-cookie"&&w.push(j);if(w.length>0)for(let h of w)try{o.setCookies(h,c,s)}catch(j){console.warn("Failed to set cookie from header",h,j)}return R}var l=v;var C=class{zjuamInstance;session="";firstTime=!0;jar=u();constructor(t){this.zjuamInstance=t}async login(){console.log("[COURSES] login begins");let t="https://courses.zju.edu.cn/user/index";for(;new URL(t).hostname!=="zjuam.zju.edu.cn";)console.log("[COURSES] Redirect:",t),t=(await l(t,{redirect:"manual"},this.jar)).headers.get("Location");console.log("[COURSES] Redirected to ZJUAM for authentication:",t),t=await this.zjuamInstance.loginSvc(new URL(t).searchParams.get("service")||""),console.log("[COURSES] Returned from ZJUAM, finalizing login at:",t);let e=await l(t,{redirect:"manual"},this.jar);for(;;){console.log("[COURSES] Redirect:",t);let o=await l(t,{redirect:"manual"},this.jar),n=await o.text();if(o.status==200&&n.includes('meta http-equiv="refresh"')){t=n.match(/meta http-equiv="refresh" content="0;URL=([^"]+)"/)[1];continue}if(!(o.status>=300&&o.status<400))break;t=o.headers.get("Location")}return!0}async fetch(t,e={}){return this.firstTime&&(await this.login(),this.firstTime=!1),console.log("[COURSES] Fetching url:",t),e.headers={...e?.headers},l(t,e,this.jar)}};var x=class{zjuamInstance;cookiesJar;logedIn=!1;constructor(t){this.zjuamInstance=t,this.cookiesJar=u()}async login(){await l("https://zdbk.zju.edu.cn/jwglxt/xtgl/login_cxSsoLoginUrl.html",{method:"POST"},this.cookiesJar);let t=await this.zjuamInstance.loginSvc("https://zdbk.zju.edu.cn/jwglxt/xtgl/login_ssologin.html"),e=await l(t,{redirect:"manual"},this.cookiesJar);if(e.status!==302)throw new Error("Login failed, status code is "+e.status);if(!e.headers.get("Location")?.includes("https://zdbk.zju.edu.cn/jwglxt/xtgl/index_initMenu.html"))throw new Error("Login failed, redirect to unexpected url "+e.headers.get("Location"));return!0}async fetch(t,e){return this.logedIn||await this.login().then(o=>this.logedIn=o),l(t,{...e,headers:{...e?.headers}},this.cookiesJar)}};function L(r,t,e){let o=0n;for(let i of r)o=o*256n+BigInt(i.charCodeAt(0));let n=BigInt("0x"+e),a=BigInt("0x"+t);return(o**a%n).toString(16)}var O="https://zjuam.zju.edu.cn/cas/v2/getPubKey",y=class{username;password;jar=u();firstinLogin=!1;constructor(t,e){this.username=t,this.password=e}async#t(t){console.log("[ZJUAM] Attempting to login to ZJUAM.");let e;try{e=await l(t,void 0,this.jar).then(i=>i.text())}catch{return Promise.reject({message:"Failed when fetch login page at first time."})}let o=e.match(/name="execution" value="([^"]+)"/)?.[1]??"";if(!o)return Promise.reject({message:"First-time login page doesn't contain execution string."});let n;try{n=await l(O,void 0,this.jar).then(i=>i.json())}catch{return Promise.reject({message:"Failed when fetch pubkey."})}let a=L(this.password,n.exponent,n.modulus),c=["username="+this.username,"password="+a,"execution="+o,"_eventId=submit","authcode="].join("&"),s={"Content-Type":"application/x-www-form-urlencoded","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36 Edg/131.0.0.0"};try{let i=await l(t,{method:"POST",body:c,headers:s,redirect:"manual"},this.jar);if(i.status===302)return this.firstinLogin=!0,console.log("[ZJUAM] Login success."),i.headers.get("Location");if(i.status===200){let f=(await i.text()).match(/<span id="msg">([^<]+)<\/span>/)?.[1];return Promise.reject({message:"Failed to login: "+f})}else return Promise.reject({message:"Failed to login with status code "+i.status})}catch{return Promise.reject({message:"Failed when posting login."})}}login(){return this.#t("https://zjuam.zju.edu.cn/cas/login")}async fetch(t,e={}){this.firstinLogin||await this.login().catch(n=>{console.error(n)});let o={...e.headers||{},"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36 Edg/131.0.0.0"};return l(t,{...e,headers:o},this.jar)}async loginSvc(t){console.log("[ZJUAM] Attempting to login to service: "+t);let e="https://zjuam.zju.edu.cn/cas/login?service="+encodeURIComponent(t);if(this.firstinLogin){let o=await this.fetch(e,{redirect:"manual",method:"GET"});return console.log("loginSvc,",o.status,o.headers.get("Location")),o.status===302?o.headers.get("Location"):o.status===200?this.#t(e):Promise.reject({message:"Login failed with status "+o.status})}else return this.#t(e)}async loginSvc_oauth2(t){console.log("[ZJUAM] Attempting to login to oauth2 service: "+t);let e=t;for(;new URL(e).hostname==="zjuam.zju.edu.cn";)console.log("[ZJUAM] Redirect:",e),e=(await this.fetch(e,{redirect:"manual",method:"GET"})).headers.get("Location");return e}};var S=class{zjuamInstance;cookies;constructor(t,e){this.zjuamInstance=t,this.cookies={}}token="";session;async login(){let t=await this.zjuamInstance.loginSvc("https://course.zju.edu.cn/ua/login?platform=WEB");console.log(t),await fetch(t,{redirect:"manual"}).then(e=>(console.log(e.status),console.log(e.headers.getSetCookie()),e.headers.getSetCookie().forEach(o=>{let[n,a]=o.split(";")[0].split("=");this.cookies[n]=a}),e.headers.get("Location"))).then(e=>fetch(e,{redirect:"manual",headers:{Cookie:Object.entries(this.cookies).map(([o,n])=>`${o}=${n}`).join("; ")}})).then(e=>(console.log(e.status),console.log(e.headers.getSetCookie()),console.log(e.headers.get("Location")),this.token=new URL(e.headers.get("Location")).searchParams.get("token"),fetch(e.headers.get("Location"),{}))).then(e=>{console.log(e.status),console.log(e.headers.getSetCookie()),console.log(e.headers.get("Location"))})}};import Z from"crypto";var U="https://form.zju.edu.cn/",P=r=>Buffer.from(r).toString("base64");var E="74102f635c6d4b22b270239bc1e84f50",_=r=>{let t=Z.createCipheriv("aes-128-ecb",Buffer.from(E,"hex"),null),e=t.update(r,"utf8","base64");return e+=t.final("base64"),P(e)},b=class{token="";zjuamInstance;constructor(t){this.zjuamInstance=t}async login(){return console.log("[FORM] login begins"),this.zjuamInstance.loginSvc(U).then(t=>{let e=t.split("ticket=")[1].split("&")[0];return fetch(`https://form.zju.edu.cn/dfi/validateLogin?ticket=${_(e)}&service=${encodeURIComponent(U)}`)}).then(t=>t.json()).then(t=>{if(t.code===2e3)return console.log("[FORM] login success"),this.token=t.data.token,!0;throw new Error("[FORM] login failed",t)}).catch(t=>{throw t})}async fetch(t){this.token===""&&await this.login();try{let e=await fetch(t,{headers:{authentication:this.token}});if(e.status===200)return e;if(e.status===401||e.status===403)return this.token="",this.fetch(t);throw new Error(`Request failed with status ${e.status}`)}catch(e){throw console.error("Fetch error:",e),e}}};var A=class{zjuamInstance;token="";jar=u();constructor(t){this.zjuamInstance=t}async login(){console.log("[CLASSROOM] Attempting to login to classroom.zju.edu.cn");let t="https://tgmedia.cmc.zju.edu.cn/index.php?r=auth%2Flogin&forward=https%3A%2F%2Fclassroom.zju.edu.cn%2F";for(;new URL(t).hostname!=="zjuam.zju.edu.cn";)console.log("[CLASSROOM] Redirect:",t),t=(await l(t,{redirect:"manual"},this.jar)).headers.get("Location");for(console.log("[CLASSROOM] Redirected to ZJUAM for authentication:",t),t=await this.zjuamInstance.loginSvc_oauth2(t),console.log("[CLASSROOM] Returned from ZJUAM, finalizing login at:",t);;){console.log("[CLASSROOM] Redirect:",t);let e=await l(t,{redirect:"manual"},this.jar),o=await e.text();if(e.status==200&&o.includes('meta http-equiv="refresh"')){t=o.match(/meta http-equiv="refresh" content="0;URL=([^"]+)"/)[1];continue}if(!(e.status>=300&&e.status<400))break;t=e.headers.get("Location")}}async fetch(t,e={}){(!this.token||this.token.length===0)&&await this.login(),console.log("[CLASSROOM] Fetching:",t);let o={...e.headers,Authorization:`Bearer ${this.token}`};return l(t,{...e,headers:o},this.jar)}};export{A as CLASSROOM,S as COURSE,C as COURSES,b as FORM,x as ZDBK,y as ZJUAM};
//# sourceMappingURL=login-ZJU.js.map
